<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 500">
  <defs>
    <linearGradient id="workerGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#4F46E5;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#3730A3;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="taskGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#10B981;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="recoveryGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#F59E0B;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#D97706;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="zombieGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#6B7280;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#4B5563;stop-opacity:1" />
    </linearGradient>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.2"/>
    </filter>
  </defs>
  
  <!-- Background -->
  <rect width="800" height="500" fill="#F8FAFC"/>
  
  <!-- Title -->
  <text x="400" y="35" text-anchor="middle" font-family="system-ui, -apple-system, sans-serif" font-size="20" font-weight="bold" fill="#1E293B">Exactly-Once Execution: Fence Token Flow</text>
  
  <!-- Step 1: Worker A acquires lease -->
  <g transform="translate(30, 60)">
    <rect x="0" y="0" width="230" height="65" rx="8" fill="white" stroke="#E2E8F0" stroke-width="2" filter="url(#shadow)"/>
    <circle cx="20" cy="32" r="14" fill="#4F46E5"/>
    <text x="20" y="37" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="white">1</text>
    <text x="45" y="25" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#1E293B">Worker A acquires lease</text>
    <rect x="45" y="35" width="70" height="22" rx="4" fill="url(#workerGrad)"/>
    <text x="80" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="white">Worker A</text>
    <text x="125" y="50" font-family="system-ui, sans-serif" font-size="14" fill="#10B981">â†’</text>
    <rect x="140" y="35" width="50" height="22" rx="4" fill="url(#taskGrad)"/>
    <text x="165" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="white">Task</text>
    <text x="200" y="50" font-family="system-ui, sans-serif" font-size="9" fill="#6B7280">token=42</text>
  </g>
  
  <!-- Step 2: Worker B blocked -->
  <g transform="translate(280, 60)">
    <rect x="0" y="0" width="230" height="65" rx="8" fill="white" stroke="#E2E8F0" stroke-width="2" filter="url(#shadow)"/>
    <circle cx="20" cy="32" r="14" fill="#4F46E5"/>
    <text x="20" y="37" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="white">2</text>
    <text x="45" y="25" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#1E293B">Worker B blocked</text>
    <rect x="45" y="35" width="70" height="22" rx="4" fill="url(#workerGrad)"/>
    <text x="80" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="white">Worker B</text>
    <text x="125" y="50" font-family="system-ui, sans-serif" font-size="14" fill="#EF4444">âœ—</text>
    <rect x="140" y="35" width="50" height="22" rx="4" fill="url(#taskGrad)"/>
    <text x="165" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="white">Task</text>
    <text x="200" y="50" font-family="system-ui, sans-serif" font-size="9" fill="#EF4444">locked</text>
  </g>
  
  <!-- Step 3: Worker A crashes -->
  <g transform="translate(540, 60)">
    <rect x="0" y="0" width="230" height="65" rx="8" fill="white" stroke="#E2E8F0" stroke-width="2" filter="url(#shadow)"/>
    <circle cx="20" cy="32" r="14" fill="#4F46E5"/>
    <text x="20" y="37" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="white">3</text>
    <text x="45" y="25" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#1E293B">Worker A crashes</text>
    <rect x="45" y="35" width="70" height="22" rx="4" fill="url(#zombieGrad)"/>
    <text x="80" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="white">Worker A</text>
    <text x="125" y="50" font-family="system-ui, sans-serif" font-size="14">ğŸ’€</text>
    <rect x="140" y="35" width="50" height="22" rx="4" fill="url(#taskGrad)" opacity="0.6"/>
    <text x="165" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="white">Task</text>
    <text x="200" y="50" font-family="system-ui, sans-serif" font-size="9" fill="#F59E0B">expiring</text>
  </g>
  
  <!-- Arrow down -->
  <path d="M 655 135 L 655 165 L 145 165 L 145 195" stroke="#CBD5E1" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
  <polygon points="145,200 140,190 150,190" fill="#CBD5E1"/>
  
  <!-- Step 4: Recovery detects -->
  <g transform="translate(30, 205)">
    <rect x="0" y="0" width="230" height="65" rx="8" fill="white" stroke="#F59E0B" stroke-width="2" filter="url(#shadow)"/>
    <circle cx="20" cy="32" r="14" fill="#F59E0B"/>
    <text x="20" y="37" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="white">4</text>
    <text x="45" y="25" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#1E293B">Recovery increments token</text>
    <rect x="45" y="35" width="80" height="22" rx="4" fill="url(#recoveryGrad)"/>
    <text x="85" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="white">Recovery Eng</text>
    <text x="135" y="50" font-family="system-ui, sans-serif" font-size="14" fill="#10B981">â†’</text>
    <rect x="150" y="35" width="50" height="22" rx="4" fill="url(#taskGrad)"/>
    <text x="175" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="white">Task</text>
    <text x="210" y="50" font-family="system-ui, sans-serif" font-size="9" fill="#10B981">token=43</text>
  </g>
  
  <!-- Step 5: Worker B acquires -->
  <g transform="translate(280, 205)">
    <rect x="0" y="0" width="230" height="65" rx="8" fill="white" stroke="#10B981" stroke-width="2" filter="url(#shadow)"/>
    <circle cx="20" cy="32" r="14" fill="#10B981"/>
    <text x="20" y="37" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="white">5</text>
    <text x="45" y="25" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#1E293B">Worker B acquires new lease</text>
    <rect x="45" y="35" width="70" height="22" rx="4" fill="url(#workerGrad)"/>
    <text x="80" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="white">Worker B</text>
    <text x="125" y="50" font-family="system-ui, sans-serif" font-size="14" fill="#10B981">âœ“</text>
    <rect x="140" y="35" width="50" height="22" rx="4" fill="url(#taskGrad)"/>
    <text x="165" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="white">Task</text>
    <text x="200" y="50" font-family="system-ui, sans-serif" font-size="9" fill="#10B981">token=43</text>
  </g>
  
  <!-- Step 6: Zombie rejected -->
  <g transform="translate(540, 205)">
    <rect x="0" y="0" width="230" height="65" rx="8" fill="white" stroke="#EF4444" stroke-width="2" filter="url(#shadow)"/>
    <circle cx="20" cy="32" r="14" fill="#EF4444"/>
    <text x="20" y="37" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="white">6</text>
    <text x="45" y="25" font-family="system-ui, sans-serif" font-size="11" font-weight="600" fill="#1E293B">Zombie A rejected</text>
    <rect x="45" y="35" width="70" height="22" rx="4" fill="url(#zombieGrad)"/>
    <text x="80" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="white">Worker A</text>
    <text x="125" y="50" font-family="system-ui, sans-serif" font-size="14" fill="#EF4444">âœ—</text>
    <rect x="140" y="35" width="50" height="22" rx="4" fill="url(#taskGrad)"/>
    <text x="165" y="50" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="white">Task</text>
    <text x="200" y="42" font-family="system-ui, sans-serif" font-size="8" fill="#EF4444">42â‰ 43</text>
    <text x="200" y="54" font-family="system-ui, sans-serif" font-size="8" fill="#EF4444">REJECT</text>
  </g>
  
  <!-- Key insight box -->
  <g transform="translate(30, 300)">
    <rect x="0" y="0" width="740" height="90" rx="10" fill="#EFF6FF" stroke="#3B82F6" stroke-width="2"/>
    <text x="20" y="28" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" fill="#1E40AF">ğŸ”‘ Why This Works</text>
    <text x="20" y="52" font-family="system-ui, sans-serif" font-size="11" fill="#1E293B">
      <tspan x="20" dy="0">The fence token acts as a monotonically increasing version number. When ownership transfers,</tspan>
      <tspan x="20" dy="16">the token increments. Any operation with an old token is rejected â€” preventing zombie workers</tspan>
      <tspan x="20" dy="16">from corrupting state after they wake up from a crash.</tspan>
    </text>
  </g>
  
  <!-- Guarantees -->
  <g transform="translate(30, 410)">
    <rect x="0" y="0" width="175" height="70" rx="8" fill="white" stroke="#E2E8F0" stroke-width="1" filter="url(#shadow)"/>
    <text x="15" y="22" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#4F46E5">ğŸ”’ Mutual Exclusion</text>
    <text x="15" y="40" font-family="system-ui, sans-serif" font-size="9" fill="#64748B">One worker per task</text>
    <text x="15" y="55" font-family="system-ui, sans-serif" font-size="9" fill="#64748B">via lease ownership</text>
  </g>
  
  <g transform="translate(220, 410)">
    <rect x="0" y="0" width="175" height="70" rx="8" fill="white" stroke="#E2E8F0" stroke-width="1" filter="url(#shadow)"/>
    <text x="15" y="22" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#10B981">ğŸ›¡ï¸ Fence Validation</text>
    <text x="15" y="40" font-family="system-ui, sans-serif" font-size="9" fill="#64748B">Stale tokens rejected</text>
    <text x="15" y="55" font-family="system-ui, sans-serif" font-size="9" fill="#64748B">on every operation</text>
  </g>
  
  <g transform="translate(410, 410)">
    <rect x="0" y="0" width="175" height="70" rx="8" fill="white" stroke="#E2E8F0" stroke-width="1" filter="url(#shadow)"/>
    <text x="15" y="22" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#F59E0B">ğŸ”„ Auto Recovery</text>
    <text x="15" y="40" font-family="system-ui, sans-serif" font-size="9" fill="#64748B">Expired leases detected</text>
    <text x="15" y="55" font-family="system-ui, sans-serif" font-size="9" fill="#64748B">and reassigned</text>
  </g>
  
  <g transform="translate(600, 410)">
    <rect x="0" y="0" width="170" height="70" rx="8" fill="white" stroke="#E2E8F0" stroke-width="1" filter="url(#shadow)"/>
    <text x="15" y="22" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#EF4444">ğŸ”‘ Idempotency</text>
    <text x="15" y="40" font-family="system-ui, sans-serif" font-size="9" fill="#64748B">External calls use</text>
    <text x="15" y="55" font-family="system-ui, sans-serif" font-size="9" fill="#64748B">idempotency keys</text>
  </g>
</svg>